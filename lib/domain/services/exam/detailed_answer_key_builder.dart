// lib/core/services/detailed_answer_key_builder.dart
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;
import '../../models/enhanced_exam_models.dart';
import '../../models/exam_models.dart';

/// ÏÉÅÏÑ∏ ÎãµÏïàÏßÄ ÎπåÎçî
class DetailedAnswerKeyBuilder {
  
  /// ÏôÑÏ†ÑÌïú ÎãµÏïà Ìï≠Î™© ÏÉùÏÑ±
  static pw.Widget buildDetailedAnswerItem(
    int questionIndex,
    EnhancedExamQuestion question,
    pw.Font regularFont,
    pw.Font boldFont,
    pw.Font italicFont,
    ExamConfig config,
  ) {
    return pw.Container(
      margin: const pw.EdgeInsets.only(bottom: 25),
      padding: const pw.EdgeInsets.all(15),
      decoration: pw.BoxDecoration(
        border: pw.Border.all(color: PdfColors.grey300),
        borderRadius: pw.BorderRadius.circular(8),
        color: PdfColors.grey50,
      ),
      child: pw.Column(
        crossAxisAlignment: pw.CrossAxisAlignment.start,
        children: [
          // Î¨∏Ï†ú Î≤àÌò∏ÏôÄ Ï†ïÎãµ
          _buildAnswerHeader(questionIndex, question, boldFont),
          
          pw.SizedBox(height: 12),
          
          // Îã®Í≥ÑÎ≥Ñ Ìï¥ÏÑ§ (ÏÉÅÏÑ∏ ÏòµÏÖòÏù¥ ÏºúÏ†∏ÏûàÏùÑ ÎïåÎßå)
          if (config.includeDetailedExplanations) ...[
            _buildStepByStepSolution(question, regularFont, boldFont),
            pw.SizedBox(height: 10),
          ],
          
          // Î¨∏Î≤ï Ìè¨Ïù∏Ìä∏
          if (question.explanation.grammarPoint.isNotEmpty) ...[
            _buildGrammarPoint(question, regularFont, boldFont),
            pw.SizedBox(height: 8),
          ],
          
          // Ïñ¥Ìúò ÏÑ§Î™Ö
          if (question.explanation.vocabularyNote.isNotEmpty) ...[
            _buildVocabularyNote(question, regularFont, boldFont),
            pw.SizedBox(height: 8),
          ],
          
          // ÌïôÏäµ ÌåÅ
          if (question.explanation.learningTip.isNotEmpty) ...[
            _buildLearningTip(question, regularFont, italicFont),
            pw.SizedBox(height: 8),
          ],
          
          // ÌùîÌïú Ïã§ÏàòÎì§
          if (question.explanation.commonMistakes.isNotEmpty) ...[
            _buildCommonMistakes(question, regularFont, boldFont),
            pw.SizedBox(height: 8),
          ],
          
          // Í¥ÄÎ†® Îã®Ïñ¥Îì§
          if (question.explanation.relatedWords.isNotEmpty) ...[
            _buildRelatedWords(question, regularFont, boldFont),
          ],
        ],
      ),
    );
  }

  /// ÎãµÏïà Ìó§Îçî (Î¨∏Ï†ú Î≤àÌò∏, Ï†ïÎãµ, Î∞∞Ï†ê)
  static pw.Widget _buildAnswerHeader(
    int questionIndex,
    EnhancedExamQuestion question,
    pw.Font boldFont,
  ) {
    return pw.Container(
      padding: const pw.EdgeInsets.all(12),
      decoration: pw.BoxDecoration(
        gradient: pw.LinearGradient(
          colors: [_getQuestionTypeColor(question.type), _getQuestionTypeColor(question.type).shade(0.8)],
        ),
        borderRadius: pw.BorderRadius.circular(8),
      ),
      child: pw.Row(
        children: [
          // Î¨∏Ï†ú Î≤àÌò∏ ÏõêÌòï Î∞∞ÏßÄ
          pw.Container(
            width: 35,
            height: 35,
            decoration: pw.BoxDecoration(
              color: PdfColors.white,
              shape: pw.BoxShape.circle,
            ),
            child: pw.Center(
              child: pw.Text(
                '$questionIndex',
                style: pw.TextStyle(
                  font: boldFont,
                  fontSize: 16,
                  color: _getQuestionTypeColor(question.type),
                ),
              ),
            ),
          ),
          
          pw.SizedBox(width: 15),
          
          // Î¨∏Ï†ú Ï†ïÎ≥¥
          pw.Expanded(
            child: pw.Column(
              crossAxisAlignment: pw.CrossAxisAlignment.start,
              children: [
                pw.Text(
                  _getQuestionTypeLabel(question.type),
                  style: pw.TextStyle(
                    font: boldFont,
                    fontSize: 12,
                    color: PdfColors.white,
                  ),
                ),
                pw.SizedBox(height: 3),
                pw.Text(
                  'Ï†ïÎãµ: ${_formatAnswer(question.answer)}',
                  style: pw.TextStyle(
                    font: boldFont,
                    fontSize: 14,
                    color: PdfColors.white,
                  ),
                ),
              ],
            ),
          ),
          
          // Î∞∞Ï†ê ÌëúÏãú
          pw.Container(
            padding: const pw.EdgeInsets.symmetric(horizontal: 8, vertical: 4),
            decoration: pw.BoxDecoration(
              color: PdfColors.white,
              borderRadius: pw.BorderRadius.circular(12),
            ),
            child: pw.Text(
              '${question.points}Ï†ê',
              style: pw.TextStyle(
                font: boldFont,
                fontSize: 12,
                color: _getQuestionTypeColor(question.type),
              ),
            ),
          ),
        ],
      ),
    );
  }

  /// Îã®Í≥ÑÎ≥Ñ ÌíÄÏù¥ Í≥ºÏ†ï
  static pw.Widget _buildStepByStepSolution(
    EnhancedExamQuestion question,
    pw.Font regularFont,
    pw.Font boldFont,
  ) {
    return pw.Container(
      padding: const pw.EdgeInsets.all(12),
      decoration: pw.BoxDecoration(
        color: PdfColors.blue50,
        borderRadius: pw.BorderRadius.circular(6),
        border: pw.Border.all(color: PdfColors.blue200),
      ),
      child: pw.Column(
        crossAxisAlignment: pw.CrossAxisAlignment.start,
        children: [
          pw.Row(
            children: [
              pw.Container(
                width: 20,
                height: 20,
                decoration: pw.BoxDecoration(
                  color: PdfColors.blue500,
                  shape: pw.BoxShape.circle,
                ),
                child: pw.Center(
                  child: pw.Text(
                    'üìù',
                    style: pw.TextStyle(fontSize: 10),
                  ),
                ),
              ),
              pw.SizedBox(width: 8),
              pw.Text(
                'Îã®Í≥ÑÎ≥Ñ ÌíÄÏù¥',
                style: pw.TextStyle(
                  font: boldFont,
                  fontSize: 12,
                  color: PdfColors.blue800,
                ),
              ),
            ],
          ),
          pw.SizedBox(height: 8),
          pw.Text(
            question.explanation.stepByStepSolution,
            style: pw.TextStyle(
              font: regularFont,
              fontSize: 10,
              lineSpacing: 1.4,
            ),
          ),
        ],
      ),
    );
  }

  /// Î¨∏Î≤ï Ìè¨Ïù∏Ìä∏
  static pw.Widget _buildGrammarPoint(
    EnhancedExamQuestion question,
    pw.Font regularFont,
    pw.Font boldFont,
  ) {
    return pw.Container(
      padding: const pw.EdgeInsets.all(10),
      decoration: pw.BoxDecoration(
        color: PdfColors.orange50,
        borderRadius: pw.BorderRadius.circular(6),
        border: pw.Border.all(color: PdfColors.orange200),
      ),
      child: pw.Row(
        crossAxisAlignment: pw.CrossAxisAlignment.start,
        children: [
          pw.Container(
            margin: const pw.EdgeInsets.only(top: 2),
            child: pw.Text(
              'üìñ',
              style: pw.TextStyle(fontSize: 10),
            ),
          ),
          pw.SizedBox(width: 8),
          pw.Expanded(
            child: pw.Column(
              crossAxisAlignment: pw.CrossAxisAlignment.start,
              children: [
                pw.Text(
                  'Î¨∏Î≤ï Ìè¨Ïù∏Ìä∏',
                  style: pw.TextStyle(
                    font: boldFont,
                    fontSize: 11,
                    color: PdfColors.orange800,
                  ),
                ),
                pw.SizedBox(height: 4),
                pw.Text(
                  question.explanation.grammarPoint,
                  style: pw.TextStyle(
                    font: regularFont,
                    fontSize: 10,
                    lineSpacing: 1.3,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  /// Ïñ¥Ìúò ÏÑ§Î™Ö
  static pw.Widget _buildVocabularyNote(
    EnhancedExamQuestion question,
    pw.Font regularFont,
    pw.Font boldFont,
  ) {
    return pw.Container(
      padding: const pw.EdgeInsets.all(10),
      decoration: pw.BoxDecoration(
        color: PdfColors.green50,
        borderRadius: pw.BorderRadius.circular(6),
        border: pw.Border.all(color: PdfColors.green200),
      ),
      child: pw.Row(
        crossAxisAlignment: pw.CrossAxisAlignment.start,
        children: [
          pw.Container(
            margin: const pw.EdgeInsets.only(top: 2),
            child: pw.Text(
              'üí°',
              style: pw.TextStyle(fontSize: 10),
            ),
          ),
          pw.SizedBox(width: 8),
          pw.Expanded(
            child: pw.Column(
              crossAxisAlignment: pw.CrossAxisAlignment.start,
              children: [
                pw.Text(
                  'Ïñ¥Ìúò ÏÑ§Î™Ö',
                  style: pw.TextStyle(
                    font: boldFont,
                    fontSize: 11,
                    color: PdfColors.green800,
                  ),
                ),
                pw.SizedBox(height: 4),
                pw.Text(
                  question.explanation.vocabularyNote,
                  style: pw.TextStyle(
                    font: regularFont,
                    fontSize: 10,
                    lineSpacing: 1.3,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  /// ÌïôÏäµ ÌåÅ
  static pw.Widget _buildLearningTip(
    EnhancedExamQuestion question,
    pw.Font regularFont,
    pw.Font italicFont,
  ) {
    return pw.Container(
      padding: const pw.EdgeInsets.all(10),
      decoration: pw.BoxDecoration(
        color: PdfColors.purple50,
        borderRadius: pw.BorderRadius.circular(6),
        border: pw.Border.all(color: PdfColors.purple200),
      ),
      child: pw.Row(
        crossAxisAlignment: pw.CrossAxisAlignment.start,
        children: [
          pw.Container(
            margin: const pw.EdgeInsets.only(top: 2),
            child: pw.Text(
              'üí≠',
              style: pw.TextStyle(fontSize: 10),
            ),
          ),
          pw.SizedBox(width: 8),
          pw.Expanded(
            child: pw.Text(
              'üí° ÌïôÏäµ ÌåÅ: ${question.explanation.learningTip}',
              style: pw.TextStyle(
                font: italicFont,
                fontSize: 10,
                lineSpacing: 1.3,
                color: PdfColors.purple700,
              ),
            ),
          ),
        ],
      ),
    );
  }

  /// ÌùîÌïú Ïã§ÏàòÎì§
  static pw.Widget _buildCommonMistakes(
    EnhancedExamQuestion question,
    pw.Font regularFont,
    pw.Font boldFont,
  ) {
    return pw.Container(
      padding: const pw.EdgeInsets.all(10),
      decoration: pw.BoxDecoration(
        color: PdfColors.red50,
        borderRadius: pw.BorderRadius.circular(6),
        border: pw.Border.all(color: PdfColors.red200),
      ),
      child: pw.Column(
        crossAxisAlignment: pw.CrossAxisAlignment.start,
        children: [
          pw.Row(
            children: [
              pw.Text(
                '‚ö†Ô∏è',
                style: pw.TextStyle(fontSize: 10),
              ),
              pw.SizedBox(width: 8),
              pw.Text(
                'ÌùîÌïú Ïã§Ïàò',
                style: pw.TextStyle(
                  font: boldFont,
                  fontSize: 11,
                  color: PdfColors.red800,
                ),
              ),
            ],
          ),
          pw.SizedBox(height: 6),
          ...question.explanation.commonMistakes.map((mistake) => 
            pw.Padding(
              padding: const pw.EdgeInsets.only(left: 16, bottom: 3),
              child: pw.Row(
                crossAxisAlignment: pw.CrossAxisAlignment.start,
                children: [
                  pw.Text(
                    '‚Ä¢ ',
                    style: pw.TextStyle(
                      font: regularFont,
                      fontSize: 10,
                      color: PdfColors.red700,
                    ),
                  ),
                  pw.Expanded(
                    child: pw.Text(
                      mistake,
                      style: pw.TextStyle(
                        font: regularFont,
                        fontSize: 10,
                        color: PdfColors.red700,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ).toList(),
        ],
      ),
    );
  }

  /// Í¥ÄÎ†® Îã®Ïñ¥Îì§
  static pw.Widget _buildRelatedWords(
    EnhancedExamQuestion question,
    pw.Font regularFont,
    pw.Font boldFont,
  ) {
    return pw.Container(
      padding: const pw.EdgeInsets.all(10),
      decoration: pw.BoxDecoration(
        color: PdfColors.teal50,
        borderRadius: pw.BorderRadius.circular(6),
        border: pw.Border.all(color: PdfColors.teal200),
      ),
      child: pw.Column(
        crossAxisAlignment: pw.CrossAxisAlignment.start,
        children: [
          pw.Row(
            children: [
              pw.Text(
                'üîó',
                style: pw.TextStyle(fontSize: 10),
              ),
              pw.SizedBox(width: 8),
              pw.Text(
                'Í¥ÄÎ†® Îã®Ïñ¥',
                style: pw.TextStyle(
                  font: boldFont,
                  fontSize: 11,
                  color: PdfColors.teal800,
                ),
              ),
            ],
          ),
          pw.SizedBox(height: 6),
          pw.Wrap(
            spacing: 6,
            runSpacing: 4,
            children: question.explanation.relatedWords.map((word) =>
              pw.Container(
                padding: const pw.EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                decoration: pw.BoxDecoration(
                  color: PdfColors.teal100,
                  borderRadius: pw.BorderRadius.circular(12),
                ),
                child: pw.Text(
                  word,
                  style: pw.TextStyle(
                    font: regularFont,
                    fontSize: 9,
                    color: PdfColors.teal800,
                  ),
                ),
              ),
            ).toList(),
          ),
        ],
      ),
    );
  }

  /// Ï±ÑÏ†ê Í∏∞Ï§Ä Ìï≠Î™© ÏÉùÏÑ±
  static pw.Widget buildGradingCriteriaItem(
    int questionIndex,
    EnhancedExamQuestion question,
    pw.Font regularFont,
    pw.Font boldFont,
  ) {
    return pw.Container(
      margin: const pw.EdgeInsets.only(bottom: 20),
      padding: const pw.EdgeInsets.all(15),
      decoration: pw.BoxDecoration(
        border: pw.Border.all(color: PdfColors.purple300),
        borderRadius: pw.BorderRadius.circular(8),
        color: PdfColors.purple50,
      ),
      child: pw.Column(
        crossAxisAlignment: pw.CrossAxisAlignment.start,
        children: [
          // Î¨∏Ï†ú Ï†ïÎ≥¥ Ìó§Îçî
          pw.Row(
            children: [
              pw.Container(
                width: 30,
                height: 30,
                decoration: pw.BoxDecoration(
                  color: PdfColors.purple600,
                  shape: pw.BoxShape.circle,
                ),
                child: pw.Center(
                  child: pw.Text(
                    '$questionIndex',
                    style: pw.TextStyle(
                      font: boldFont,
                      fontSize: 14,
                      color: PdfColors.white,
                    ),
                  ),
                ),
              ),
              pw.SizedBox(width: 12),
              pw.Expanded(
                child: pw.Column(
                  crossAxisAlignment: pw.CrossAxisAlignment.start,
                  children: [
                    pw.Text(
                      _getQuestionTypeLabel(question.type),
                      style: pw.TextStyle(
                        font: boldFont,
                        fontSize: 12,
                        color: PdfColors.purple800,
                      ),
                    ),
                    pw.Text(
                      'Î∞∞Ï†ê: ${question.gradingCriteria.fullPoints}Ï†ê',
                      style: pw.TextStyle(
                        font: regularFont,
                        fontSize: 10,
                        color: PdfColors.purple700,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
          
          pw.SizedBox(height: 12),
          
          // Ï±ÑÏ†ê Í∏∞Ï§Ä
          pw.Container(
            width: double.infinity,
            padding: const pw.EdgeInsets.all(12),
            decoration: pw.BoxDecoration(
              color: PdfColors.white,
              borderRadius: pw.BorderRadius.circular(6),
              border: pw.Border.all(color: PdfColors.purple200),
            ),
            child: pw.Column(
              crossAxisAlignment: pw.CrossAxisAlignment.start,
              children: [
                pw.Text(
                  'Ï±ÑÏ†ê Í∏∞Ï§Ä',
                  style: pw.TextStyle(
                    font: boldFont,
                    fontSize: 11,
                    color: PdfColors.purple800,
                  ),
                ),
                pw.SizedBox(height: 6),
                pw.Text(
                  question.gradingCriteria.rubric,
                  style: pw.TextStyle(
                    font: regularFont,
                    fontSize: 10,
                    lineSpacing: 1.3,
                  ),
                ),
              ],
            ),
          ),
          
          // Î∂ÄÎ∂Ñ Ï†êÏàò (ÏûàÎäî Í≤ΩÏö∞)
          if (question.gradingCriteria.partialPoints > 0) ...[
            pw.SizedBox(height: 8),
            pw.Container(
              width: double.infinity,
              padding: const pw.EdgeInsets.all(10),
              decoration: pw.BoxDecoration(
                color: PdfColors.orange50,
                borderRadius: pw.BorderRadius.circular(6),
                border: pw.Border.all(color: PdfColors.orange200),
              ),
              child: pw.Text(
                'Î∂ÄÎ∂Ñ Ï†êÏàò: ${question.gradingCriteria.partialPoints}Ï†ê (ÏùòÎØ∏Í∞Ä ÌÜµÌïòÎÇò ÏôÑÏ†ÑÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞)',
                style: pw.TextStyle(
                  font: regularFont,
                  fontSize: 10,
                  color: PdfColors.orange800,
                ),
              ),
            ),
          ],
          
          // ÌïÑÏàò ÌÇ§ÏõåÎìú (ÏûàÎäî Í≤ΩÏö∞)
          if (question.gradingCriteria.keywords.isNotEmpty) ...[
            pw.SizedBox(height: 8),
            pw.Container(
              width: double.infinity,
              padding: const pw.EdgeInsets.all(10),
              decoration: pw.BoxDecoration(
                color: PdfColors.blue50,
                borderRadius: pw.BorderRadius.circular(6),
                border: pw.Border.all(color: PdfColors.blue200),
              ),
              child: pw.Column(
                crossAxisAlignment: pw.CrossAxisAlignment.start,
                children: [
                  pw.Text(
                    'ÌïÑÏàò ÌÇ§ÏõåÎìú:',
                    style: pw.TextStyle(
                      font: boldFont,
                      fontSize: 10,
                      color: PdfColors.blue800,
                    ),
                  ),
                  pw.SizedBox(height: 4),
                  pw.Wrap(
                    spacing: 6,
                    runSpacing: 4,
                    children: question.gradingCriteria.keywords.map((keyword) =>
                      pw.Container(
                        padding: const pw.EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                        decoration: pw.BoxDecoration(
                          color: PdfColors.blue100,
                          borderRadius: pw.BorderRadius.circular(10),
                        ),
                        child: pw.Text(
                          keyword,
                          style: pw.TextStyle(
                            font: regularFont,
                            fontSize: 9,
                            color: PdfColors.blue800,
                          ),
                        ),
                      ),
                    ).toList(),
                  ),
                ],
              ),
            ),
          ],
        ],
      ),
    );
  }

  // ===== Î≥¥Ï°∞ Î©îÏÑúÎìúÎì§ =====

  static String _getQuestionTypeLabel(QuestionType type) {
    final info = EnhancedQuestionTypeInfo.getInfo(type);
    return info?.name ?? type.toString().split('.').last;
  }

  static PdfColor _getQuestionTypeColor(QuestionType type) {
    switch (type) {
      case QuestionType.fillInBlanks:
        return PdfColors.blue500;
      case QuestionType.contextMeaning:
        return PdfColors.orange500;
      case QuestionType.korToEngTranslation:
        return PdfColors.purple500;
    }
  }

  static String _formatAnswer(dynamic answer) {
    if (answer is List) {
      return answer.join(', ');
    }
    return answer.toString();
  }
}